---
title: "MSCA 31006 Time Series - Final Project - ARIMA Model (WIP)"
author: "Whitney Schreiber"
date: '2022-05-26'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load packages
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(zoo)
  library(xts)
  library(tseries)
  library(forecast)
  library(TSA)
  library(reshape2)
  library(naniar)
  library(lubridate)
})
```

# Import and process data

```{r}
# import data
raw.df <- read.csv("city_temperature.csv")

# remove observations with year = 200, 201 or 2020 (only partial data), Day = 0 
wip.df <- raw.df %>% 
  filter(!Year %in% (200:201)) %>%
  filter(Day != 0)

# date data type
wip.df <- wip.df %>%
  mutate(Date = as.Date(with(wip.df,paste(Year,Month,Day,sep="-")),
                        "%Y-%m-%d")) %>%
  select(-c("Month","Day","Year"))

# number of days between the start and end date (inclusive)
n_days <- max(wip.df$Date) - min(wip.df$Date) + 1
```

Subset US cities

```{r}
# list of US cities of interest
CitiesOfInterest <- c("Chicago",
                      "Lincoln",
                      "Eugene",
                      "Kansas City",
                      "Las Vegas",
                      "Los Angeles",
                      "Minneapolis St. Paul",
                      "Phoenix",
                      "San Antonio",
                      "Salt Lake City",
                      "Cheyenne",
                      "Tulsa")

# subset US cities of interest 
df.usa <- wip.df %>% dplyr::filter((Country=="US") 
                                    & (City %in% CitiesOfInterest) 
                                    & (State!="Additional Territories")) %>%
  select(-c("Region", "Country", "State")) # drop redundant columns

# reshape data set, one column per city
df_melt <- melt(df.usa, id.vars = c("Date","City"))
df.usa2 <- dcast(df_melt, Date ~ City)

# update values where `AvgTemperature` = -99 by forward filling 
df.usa2 <- df.usa2 %>% 
  naniar::replace_with_na_all(condition = ~.x == -99) %>%
  na.locf(fromLast = FALSE)
nrow(df.usa2) == n_days
```

## Univariate Time Series: Daily, Weekly, Monthly Avg Temp in Chicago

*Create Test and Train Splits*

-   Train : 1995-01-01 - 2019-12-31
-   Test : 2020-01-01 - 2020-05-13

```{r}
# select Chicago
df <- df.usa2 %>% select(c("Date","Chicago")) %>% rename(AvgTemp = "Chicago")
```

```{r}
# ts of daily avg temp
ts.d <- df %>% select(-c("Date")) %>% ts(start=c(1995,1), frequency=365)
# split test and train
train.d <- window(ts.d, end=c(2019,365))  ;  autoplot(train.d)
test.d <- window(ts.d, start=c(2020,1))   ;  autoplot(test.d)
# check length
length(ts.d) == n_days
length(ts.d) == length(train.d) + length(test.d)
```

```{r}
# weekly avg temp
ts.w <- df %>%
  # group by week, use week start date
  group_by(WeekStart = lubridate::floor_date(df$Date,unit="week")) %>%
  # calculate avg
  summarize(AvgTemp = mean(AvgTemp) %>% round(2)) %>% 
  # drop "WeekStart" date before converting to ts
  select(-c("WeekStart")) %>%
  # convert to time series object
  ts(start=c(1995,1), deltat=1/52)
# split test and train
train.w <- window(ts.w, start=c(1995,1), end=c(2019,52))  ;  autoplot(train.w)
test.w <- window(ts.w, start=c(2020,1))  ;  autoplot(test.w)
# check length
length(ts.w) == length(train.w) + length(test.w)
```

```{r}
# monthly avg temp
ts.m <- df %>%
  # group by YearMonth
  group_by(YearMonth = as.yearmon(Date)) %>%
  # calculate avg
  summarize(AvgTemp = mean(AvgTemp) %>% round(2)) %>% 
  # drop "YearMonth" date before converting to ts
  select(-c("YearMonth")) %>%
  # convert to time series object
  ts(start=c(1995,1), frequency=12)
# split test and train
train.m <- window(ts.m, end=c(2019,12))  ;  autoplot(train.m)
test.m <- window(ts.m, start=c(2020,1))  ;  autoplot(test.m)
# check length
length(ts.m) == length(train.m) + length(test.m)
```


```{r}
kpss.test(ts.m)
McLeod.Li.test(y=ts.m)
```

# ARIMA Model

## Modeling Daily Avg Temp (Univariate ts)

```{r}
# Create model
(d.arima <- auto.arima(train.d))
# Forecast
d.forecast <- forecast(d.arima, h=length(test.d))
forecast::autoplot(d.forecast)
# Accuracy
accuracy(d.forecast, test.d) %>% round(3)
# Check residuals
forecast::checkresiduals(d.arima)
```


## Modeling Weekly Avg Temp (Univariate ts)

```{r}
# create model
(w.arima <- auto.arima(train.w))
# Forecast
w.forecast <- forecast(w.arima, h=length(test.w))
forecast::autoplot(w.forecast)
# Accuracy
accuracy(w.forecast, test.w) %>% round(3)
# Check residuals
forecast::checkresiduals(w.arima)
```

The residuals plot does not appear to be white noise, the residuals exhibit a repeating pattern.

ACF of residuals show significant spikes at lag 52 (i.e. 1 year) and 104 (i.e. 2 years).

Ljune-Box test for autocorrelation: reject the null hypothesis and conclude that the residuals are not independent (residuals have autocorrelation).


### Test additional ARIMA models

```{r}
Arima(train.w,
      order = c(3,0,0),
      seasonal = list(order=c(1,1,0), period=52))
Arima(train.w,
      order = c(3,0,1),
      seasonal = list(order=c(1,1,0), period=52))
Arima(train.w,
      order = c(0,0,1),
      seasonal = list(order=c(1,1,0), period=52))
```


### Regression with ARIMA Errors (weekly ts)

```{r}
# wip.df %>% dplyr::filter((Country=="US") & (State!="Additional Territories")) %>% select("City") %>% unique() %>% list()
```

```{r}
# cor(df.usa2 %>% select(-c("Date")))
```

Select predictors and create ts object (manually lag predictors 1 week)

```{r}
ts.Xw <- df.usa2 %>% 
  select(c("Date",
           # "Cheyenne",
           # "Kansas City",
           "Salt Lake City",
           "Tulsa",
           #"Las Vegas",
           #"Los Angeles",
           "Minneapolis St. Paul"
           #,"Phoenix"
           # ,"San Antonio"
           )) %>% 
  # group by week, use week start date
  group_by(WeekStart = lubridate::floor_date(df$Date,unit="week")) %>%
  # calculate avg
  summarize(#`Kansas City` = mean(`Kansas City`) %>% round(2)
            # `Cheyenne` = mean(`Cheyenne`) %>% round(2)
            `Salt Lake City` = mean(`Salt Lake City`) %>% round(2)
            ,`Tulsa` = mean(`Tulsa`) %>% round(2)
            #,`Las Vegas` = mean(`Las Vegas`) %>% round(2)
            #,`Los Angeles` = mean(`Los Angeles`) %>% round(2)
            ,`Minneapolis St. Paul` = mean(`Minneapolis St. Paul`) %>% round(2)
            #,`Phoenix` = mean(`Phoenix`) %>% round(2)
            # ,`San Antonio` = mean(`San Antonio`) %>% round(2)
            ) %>%
  # drop "WeekStart" date before converting to ts
  select(-c("WeekStart")) %>%
  # convert to time series object
# ts(start=c(1995,1), deltat=1/52)
  ts(start=c(1995,2), deltat=1/52)
# split test and train
train.Xw <- window(ts.Xw, start=c(1995,2), end=c(2019,52))
test.Xw <- window(ts.Xw, start=c(2020,1))

# Create model
(wX.arima <- auto.arima(window(train.w,start=c(1995,2)), xreg = train.Xw))
# Forecast
mX.forecast <- forecast(wX.arima, xreg = test.Xw, h=length(test.m))
forecast::autoplot(mX.forecast)
# Accuracy
accuracy(mX.forecast, test.m)
# Check residuals
forecast::checkresiduals(wX.arima)
```

```{r}
ts.Xw <- df.usa2 %>% 
  select(c("Date",
           # "Cheyenne",
           # "Kansas City",
           "Salt Lake City",
           "Tulsa",
           #"Las Vegas",
           #"Los Angeles",
           "Minneapolis St. Paul"
           #,"Phoenix"
           ,"San Antonio"
           )) %>% 
  # group by week, use week start date
  group_by(WeekStart = lubridate::floor_date(df$Date,unit="week")) %>%
  # calculate avg
  summarize(#`Kansas City` = mean(`Kansas City`) %>% round(2)
            # `Cheyenne` = mean(`Cheyenne`) %>% round(2)
            `Salt Lake City` = mean(`Salt Lake City`) %>% round(2)
            ,`Tulsa` = mean(`Tulsa`) %>% round(2)
            #,`Las Vegas` = mean(`Las Vegas`) %>% round(2)
            #,`Los Angeles` = mean(`Los Angeles`) %>% round(2)
            ,`Minneapolis St. Paul` = mean(`Minneapolis St. Paul`) %>% round(2)
            #,`Phoenix` = mean(`Phoenix`) %>% round(2)
            ,`San Antonio` = mean(`San Antonio`) %>% round(2)
            ) %>%
  # drop "WeekStart" date before converting to ts
  select(-c("WeekStart")) %>%
  # convert to time series object
# ts(start=c(1995,1), deltat=1/52)
  ts(start=c(1995,2), deltat=1/52)
# split test and train
train.Xw <- window(ts.Xw, start=c(1995,2), end=c(2019,52))
test.Xw <- window(ts.Xw, start=c(2020,1))

# Create model
(wX.arima <- auto.arima(window(train.w,start=c(1995,2)), xreg = train.Xw))
# Forecast
mX.forecast <- forecast(wX.arima, xreg = test.Xw, h=length(test.m))
forecast::autoplot(mX.forecast)
# Accuracy
accuracy(mX.forecast, test.m)
# Check residuals
forecast::checkresiduals(wX.arima)
```

```{r}
ts.Xw <- df.usa2 %>% 
  select(c("Date",
           "Cheyenne",
           # "Kansas City",
           # "Salt Lake City",
           #"Las Vegas",
           #"Los Angeles",
           "Minneapolis St. Paul"
           #,"Phoenix"
           ,"San Antonio"
           )) %>% 
  # group by week, use week start date
  group_by(WeekStart = lubridate::floor_date(df$Date,unit="week")) %>%
  # calculate avg
  summarize(#`Kansas City` = mean(`Kansas City`) %>% round(2)
            `Cheyenne` = mean(`Cheyenne`) %>% round(2)
            # `Salt Lake City` = mean(`Salt Lake City`) %>% round(2)
            #,`Las Vegas` = mean(`Las Vegas`) %>% round(2)
            #,`Los Angeles` = mean(`Los Angeles`) %>% round(2)
            ,`Minneapolis St. Paul` = mean(`Minneapolis St. Paul`) %>% round(2)
            #,`Phoenix` = mean(`Phoenix`) %>% round(2)
            ,`San Antonio` = mean(`San Antonio`) %>% round(2)
            ) %>%
  # drop "WeekStart" date before converting to ts
  select(-c("WeekStart")) %>%
  # convert to time series object
# ts(start=c(1995,1), deltat=1/52)
  ts(start=c(1995,2), deltat=1/52)
# split test and train
train.Xw <- window(ts.Xw, start=c(1995,2), end=c(2019,52))
test.Xw <- window(ts.Xw, start=c(2020,1))

# Create model
(wX.arima <- auto.arima(window(train.w,start=c(1995,2)), xreg = train.Xw))
# Forecast
mX.forecast <- forecast(wX.arima, xreg = test.Xw, h=length(test.m))
forecast::autoplot(mX.forecast)
# Accuracy
accuracy(mX.forecast, test.m)
# Check residuals
forecast::checkresiduals(wX.arima)
```

```{r}
ts.Xw <- df.usa2 %>% 
  select(c("Date",
           # "Kansas City",
           "Salt Lake City",
           #"Las Vegas",
           #"Los Angeles",
           "Minneapolis St. Paul"
           #,"Phoenix"
           ,"San Antonio"
           )) %>% 
  # group by week, use week start date
  group_by(WeekStart = lubridate::floor_date(df$Date,unit="week")) %>%
  # calculate avg
  summarize(#`Kansas City` = mean(`Kansas City`) %>% round(2)
            `Salt Lake City` = mean(`Salt Lake City`) %>% round(2)
            #,`Las Vegas` = mean(`Las Vegas`) %>% round(2)
            #,`Los Angeles` = mean(`Los Angeles`) %>% round(2)
            ,`Minneapolis St. Paul` = mean(`Minneapolis St. Paul`) %>% round(2)
            #,`Phoenix` = mean(`Phoenix`) %>% round(2)
            ,`San Antonio` = mean(`San Antonio`) %>% round(2)
            ) %>%
  # drop "WeekStart" date before converting to ts
  select(-c("WeekStart")) %>%
  # convert to time series object
  ts(start=c(1995,1), deltat=1/52)
# split test and train
train.Xw <- window(ts.Xw, start=c(1995,1), end=c(2019,52))
test.Xw <- window(ts.Xw, start=c(2020,1))

# Create model
(wX.arima <- auto.arima(train.w, xreg = train.Xw))
# Forecast
mX.forecast <- forecast(wX.arima, xreg = test.Xw, h=length(test.m))
forecast::autoplot(mX.forecast)
# Accuracy
accuracy(mX.forecast, test.m)
# Check residuals
forecast::checkresiduals(wX.arima)
```

```{r}
ts.Xw <- df.usa2 %>% 
  select(c("Date",
           "Kansas City",
           #"Las Vegas",
           #"Los Angeles",
           "Minneapolis St. Paul"
           #,"Phoenix"
           ,"San Antonio"
           )) %>% 
  # group by week, use week start date
  group_by(WeekStart = lubridate::floor_date(df$Date,unit="week")) %>%
  # calculate avg
  summarize(`Kansas City` = mean(`Kansas City`) %>% round(2)
            #,`Las Vegas` = mean(`Las Vegas`) %>% round(2)
            #,`Los Angeles` = mean(`Los Angeles`) %>% round(2)
            ,`Minneapolis St. Paul` = mean(`Minneapolis St. Paul`) %>% round(2)
            #,`Phoenix` = mean(`Phoenix`) %>% round(2)
            ,`San Antonio` = mean(`San Antonio`) %>% round(2)
            ) %>%
  # drop "WeekStart" date before converting to ts
  select(-c("WeekStart")) %>%
  # convert to time series object
  ts(start=c(1995,1), deltat=1/52)
# split test and train
train.Xw <- window(ts.Xw, start=c(1995,1), end=c(2019,52))
test.Xw <- window(ts.Xw, start=c(2020,1))

# Create model
(wX.arima <- auto.arima(train.w, xreg = train.Xw))
# Forecast
mX.forecast <- forecast(wX.arima, xreg = test.Xw, h=length(test.m))
forecast::autoplot(mX.forecast)
# Accuracy
accuracy(mX.forecast, test.m)
# Check residuals
forecast::checkresiduals(wX.arima)
```

```{r}
ts.Xw <- df.usa2 %>% 
  select(c("Date",
           "Kansas City",
           #"Las Vegas",
           #"Los Angeles",
           "Minneapolis St. Paul"
           #"Phoenix",
           #"San Antonio"
           )) %>% 
  # group by week, use week start date
  group_by(WeekStart = lubridate::floor_date(df$Date,unit="week")) %>%
  # calculate avg
  summarize(`Kansas City` = mean(`Kansas City`) %>% round(2),
            # `Las Vegas` = mean(`Las Vegas`) %>% round(2),
            # `Los Angeles` = mean(`Los Angeles`) %>% round(2),
            `Minneapolis St. Paul` = mean(`Minneapolis St. Paul`) %>% round(2)
            # `Phoenix` = mean(`Phoenix`) %>% round(2),
            # `San Antonio` = mean(`San Antonio`) %>% round(2)
            ) %>%
  # drop "WeekStart" date before converting to ts
  select(-c("WeekStart")) %>%
  # convert to time series object
  ts(start=c(1995,1), deltat=1/52)
# split test and train
train.Xw <- window(ts.Xw, start=c(1995,1), end=c(2019,52))
test.Xw <- window(ts.Xw, start=c(2020,1))

# Create model
(wX.arima <- auto.arima(train.w, xreg = train.Xw))
# Forecast
mX.forecast <- forecast(wX.arima, xreg = test.Xw, h=length(test.m))
forecast::autoplot(mX.forecast)
# Accuracy
accuracy(mX.forecast, test.m)
# Check residuals
forecast::checkresiduals(wX.arima)
```

```{r}
McLeod.Li.test(residuals(wX.arima))
```

```{r}
# Create model
(wX.arima <- auto.arima(train.w, xreg = train.Xw))
# Forecast
mX.forecast <- forecast(wX.arima, xreg = test.Xw, h=length(test.m))
forecast::autoplot(mX.forecast)
# Accuracy
accuracy(mX.forecast, test.m)
# Check residuals
forecast::checkresiduals(wX.arima)
```

Manually lag the predictors one week

```{r}
ts.Xlag.w <- df.usa2 %>% 
  select(c("Date","Kansas City","Los Angeles","Minneapolis St. Paul","Phoenix")) %>% 
  # group by week, use week start date
  group_by(WeekStart = lubridate::floor_date(df$Date,unit="week")) %>%
  # calculate avg
  summarize(`Kansas City` = mean(`Kansas City`) %>% round(2),
            `Los Angeles` = mean(`Los Angeles`) %>% round(2),
            `Minneapolis St. Paul` = mean(`Minneapolis St. Paul`) %>% round(2),
            `Phoenix` = mean(`Phoenix`) %>% round(2)) %>% 
  # drop "WeekStart" date before converting to ts
  select(-c("WeekStart")) %>%
  # convert to time series object
  # ts(start=c(1995,1), deltat=1/52)
  ts(start=c(1995,2), deltat=1/52)
# split test and train
train.Xlag.w <- window(ts.Xlag.w, start=c(1995,2), end=c(2019,52))
test.Xlag.w <- window(ts.Xlag.w, start=c(2020,1))
```

```{r}
# Create model
(wXlag.arima <- auto.arima(window(train.w, start=c(1995,2), end=c(2019,52)),
                           xreg = train.Xlag.w))
# Forecast
mXlag.forecast <- forecast(wXlag.arima, xreg = test.Xlag.w, h=length(test.m))
forecast::autoplot(mXlag.forecast)
# Accuracy
accuracy(mXlag.forecast, test.m)
# Check residuals
forecast::checkresiduals(wXlag.arima)
```



# Modeling Monthly Avg Temp (Univariate ts)

```{r}
# Create model
(m.arima <- auto.arima(train.m))
# Forecast
m1.forecast <- forecast(m.arima, h=length(test.m))
forecast::autoplot(m1.forecast)
# Accuracy
accuracy(m1.forecast, test.m)
# Check residuals
forecast::checkresiduals(m.arima)
```

Ljune-Box test >> reject the null hypothesis and conclude that the residuals are not independent (residuals have autocorrelation).





Manually lag the predictors one week

```{r}
ts.Xlag.m <- df.usa2 %>% 
  select(c("Date","Kansas City","Los Angeles","Minneapolis St. Paul","Phoenix")) %>% 
  # group by YearMonth
  group_by(YearMonth = as.yearmon(Date)) %>%
  # calculate avg
  summarize(`Kansas City` = mean(`Kansas City`) %>% round(2),
            `Los Angeles` = mean(`Los Angeles`) %>% round(2),
            `Minneapolis St. Paul` = mean(`Minneapolis St. Paul`) %>% round(2),
            `Phoenix` = mean(`Phoenix`) %>% round(2)) %>% 
  # drop "YearMonth" date before converting to ts
  select(-c("YearMonth")) %>%
  # convert to time series object
  # ts(start=c(1995,1), frequency=12)
  ts(start=c(1995,2), frequency=12)
# split test and train
train.Xlag.m <- window(ts.Xlag.m, start=c(1995,2), end=c(2019,12))
test.Xlag.m <- window(ts.Xlag.m, start=c(2020,1))
```

```{r}
# Create model
(mXlag.arima <- auto.arima(window(train.m, start=c(1995,2), end=c(2019,12)),
                           xreg = train.Xlag.m))
# Forecast
mXlag.forecast <- forecast(mXlag.arima, xreg = test.Xlag.m, h=length(test.m))
forecast::autoplot(mXlag.forecast)
# Accuracy
accuracy(mXlag.forecast, test.m)
# Check residuals
forecast::checkresiduals(mXlag.arima)
```






















