---
title: "Time Series Analysis (MSCA 31006) Final Project"
author: "Anna Auersperg"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
packages <- c("tidyverse","reshape2","gdata","xts","forecast","lubridate","tseries","fpp","tsibble","feasts")
lapply(packages, require, character.only = TRUE)
options(repr.plot.width = 20, repr.plot.height = 8)
```
# Daily temperature of major cities
https://www.kaggle.com/datasets/sudalairajkumar/daily-temperature-of-major-cities?resource=download
+ Region
+ Country
+ State
+ City
+ Month
+ Day
+ Year
+ AvgTemperature
## Data Preprocessing 
### Load Data
```{r}
df <-read.csv("city_temperature.csv")
head(df)
apply(df %>% select(-c("AvgTemperature")),2,unique)
apply(df %>% select(-c("AvgTemperature")),2,function(x) length(unique(x)))
```
## Focus on 50 US States
```{r}
df.usa <- subset(df, (Country == 'US' & State != 'Additional Territories'))

#drop region and country columns 
df.usa <- df.usa[, !(names(df.usa) %in% c('Country','Region'))]
df.usa[is.na(df.usa)]
# Remove observations where the year is 200, 201 or 2020 (only partial) or the Day is 0

df.usa <- df.usa %>% 
  filter(!Year %in% (200:201)) %>%
  filter(Year < 2020) %>%
  filter(Day != 0)

#convert date 
df.usa$date <- as.Date(with(df.usa, paste(Year, Month, Day, sep="-")),"%Y-%m-%d")
range(df.usa$date)

city.state <- df.usa %>% mutate(City.State = paste(City,State,sep=","))
city.state %>% select(City.State) %>% unique()
#combine DC and District of Columbia
all(city.state[which(city.state$City.State=="Washington DC, Maryland"),"AvgTemperature"] ==
    city.state[which(city.state$City.State=="Washington, District of Columbia"),"AvgTemperature"])

df.usa <- df.usa %>% filter(City != 'Washington DC' & State != 'Maryland')
df.usa %>% filter(AvgTemperature <= -80) %>% count(City)
df.usa <- df.usa %>% mutate(AvgTemperature = na_if(AvgTemperature, -99)) %>% 
  mutate(., AvgTemperature = na.locf(AvgTemperature, fromLast = FALSE))
df.usa
```
## EDA
Check data type
```{r}
str(df.usa)
summary(df.usa$AvgTemperature)
```

The data set represents the Avg Daily Temperature from 1995-2019, which is stationary based on both the qualitative and quantitative analysis below.

ADF >> reject null that time series is not stationary 
KPSS >> p-value > 0.05 ~ cannot reject null that TS is stationary 

```{r}
#chi <- df.usa %>% filter(City == 'Chicago, Illinois')
df.usa %>% group_by(date) %>%
  summarise(Avg = mean(AvgTemperature)) %>%
  ggplot(aes(date, Avg)) +
  geom_line() +
  labs(title = 'US Avg. Daily Temp', y = "Avg Temperature (F)", x="Date")  

adf.test(df.usa$AvgTemperature)
kpss.test(df.usa$AvgTemperature)
```

## Avg. Temperature in the US per year (1995-2019)
```{r}
df.usa %>% 
  group_by(Year) %>% 
  summarise(
    avg_year = mean(AvgTemperature)
  ) %>% 
  ggplot(aes(Year, avg_year)) +
  geom_line() +
  geom_smooth(method = 'lm', se = F) +
  labs(y="Avg Temp per Year")
```
Chart above illustrates a global increase in temperature overtime, however, there is significant variation between regions. 
```{r}
#use state datasets from r to identify regions 
library(datasets)
regions <- data.frame(State = state.name, Region = state.region)
df.usa <- left_join(df.usa, regions, by = "State")

sapply(split(df.usa$AvgTemperature, df.usa$Region), summary)

df.usa %>% 
  group_by(Year, Region) %>% 
  summarise(
    avg_year = mean(AvgTemperature)
  ) %>% 
  ggplot() +
  geom_line(aes(Year, avg_year, color = Region)) +
  facet_wrap(vars(Region)) + 
  labs(y="Avg Temp per Year and Region")
options(repr.plot.width = 20, repr.plot.height = 20)
```
### Top 10 cities with extreme variation in temperature by comparing the min and max temperature from 1995-2019.

```{r}
df.usa %>% 
  group_by(Year, City) %>% 
  summarise(
    avg_year = mean(AvgTemperature)
  ) %>% 
  group_by(City) %>% 
  summarise(
    n = n(),
    diff = max(avg_year) - min(avg_year)
  ) %>% 
  arrange(desc(diff)) %>% 
  head(10) %>% 
  ggplot() +
  geom_col(aes(City, diff, fill = diff)) +
  scale_fill_gradient(low = 'orange', high = 'red') +
  labs(title = 'Top 10 cities with highest increase in annual temperature' )
```
### Least Extreme Variation in Temp
```{r}
df.usa %>% 
  group_by(Year, City) %>% 
  summarise(
    avg_year = mean(AvgTemperature)
  ) %>% 
  group_by(City) %>% 
  summarise(
    n = n(),
    diff = max(avg_year) - min(avg_year)
  ) %>% 
  arrange(diff) %>% 
  head(10) %>% 
  ggplot() +
  geom_col(aes(City, diff, fill = diff)) +
  labs(title = 'Top 10 cities with smallest increase in annual temperature' )
```
### US Temperature by Season

```{r}
df.usa %>%
  mutate(Season = 
    ifelse(Month %in% c(12,1:2),"Winter",
           ifelse(between(Month,3,5),"Spring",
                  ifelse(between(Month,6,8),"Summer","Fall")))) %>%
  group_by(Season, Year)  %>% 
  summarise(AvgTemp = mean(AvgTemperature)) %>%  
  ggplot(aes(Year, AvgTemp, color = Season)) +
  geom_line() + 
  geom_smooth(method = 'lm', se = F) +
  labs(title = 'Temp Variation by Season', y="Temperature (F)", x="Year")
```
# Feature Engineering 
## Create time series object 
Function below will filter for a given city and convert the results to a monthly time series to forecast the next 12 months 

```{r}
# store start and end date s.t. seqence can be referenced to create a smooth series 
start.dt <- min(df.usa$date)
end.dt <- max(df.usa$date)
all.dts <- seq(start.dt, end.dt,by = "day")

create.ts <- function(city){
  mnthly <- df.usa %>% filter(City == city) %>%
    group_by(Year, Month) %>% 
    summarise(AvgTemp = round(mean(AvgTemperature),2)) %>%
    ungroup()
  mnthly <- mnthly %>% mutate(Date = make_date(Year,Month)) %>%
    select(Date,AvgTemp)
  ts(mnthly$AvgTemp, frequency = 12, start=c(1995,1,1))
}
chi <- create.ts("Chicago")
plot(chi)
```


### Train/Test
accepts a year to divide between train and test 
```{r}
train.test <- function(ts, year,split){
  if(split == 'train'){
    ts <- window(ts, end=c(year-1,12))
    
  }
  else{
    ts <- window(ts, start=c(year,1))
  }
  print(autoplot(ts))
  return(ts)
}

train <- train.test(chi, 2015, "train")
test <- train.test(chi, 2015, "test")
```
## Decompose Time series to separate into consituent components 
Chicago temperature has both a trend and seasonal component 
```{r}
dc <- decompose(train)
plot(dc)
```
## Histograms 
```{r}
par(mfrow=c(2,1))
hist(train)
hist(diff(train))
```
# Modeling 
h= 60 ~ 5 years into the future 
```{r}
model.res <- data.frame()

eval.models <- function(model, h=60){
  pred <- forecast(model, h=h)
  accuracy <- accuracy(pred, test)
  return(accuracy)
}

```



## Holt Winters
Considers past seasonal cycles, trends and random variation 
smoothing algorithm that seeks patterns by removing nosie rather than trying ot understand noise

- *alpha*: the “base value”. Higher alpha puts more weight on the most recent observations.
- *beta*: the “trend value”. Higher beta means the trend slope is more dependent on recent trend slopes.
- *gamma*: the “seasonal component”. Higher gamma puts more weighting on the most recent seasonal cycles.
```{r}
fit.HW <- HoltWinters(train, seasonal="additive")
hw.res <- eval.models(fit.HW)
plot(fit.HW)
```

## Arima 
- more detailed analysis of trainign data using lags and lagged forecast errors 
### check stationarity 
```{r}
adf.test(train)

arima.base <- auto.arima(train, seasonal=T)
arima.base
```


